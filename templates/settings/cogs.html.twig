{% extends "base.html.twig" %}

{% block title %}Settings - COGS{% endblock %}

{% block body %}
    <div class="grid grid-cols-4 mb-4">
        <h2 class="text-2xl font-medium my-4 col-span-3">{{ 'settings.cogs.title' | trans }}</h2>

        <div class="mb-4 flex flex-row-reverse">
            <a href="{{ path('settings_sync_products') }}" class="px-4 py-3 bg-green-600 rounded-md text-white outline-none focus:ring-4 shadow-lg transform active:scale-y-75 transition-transform flex">
                <i class="fa fa-sync pr-2"></i> Sync Products
            </a>
        </div>
    </div>

    {% if products %}
    <table class="w-full text-sm text-center">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th class="px-6 py-3">Image</th>
                <th class="px-6 py-3">Title</th>
                <th class="px-6 py-3">Cost</th>
            </tr>
        </thead>

        <tbody>
            {% for product in products %}
                <tr class="bg-white {% if loop.index != loop.length %}border-b{% endif %} dark:bg-gray-800 border-gray-700">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10 hidden sm:table-cell">
                                <img src="https://via.placeholder.com/35" class="w-full h-full rounded-full" alt="Product Thumbnail">
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-left">
                        {{ product.title }} ({{ product.variants | length }} variants)
                    </td>
                    <td class="px-6 py-4">-</td>
                </tr>
                {% for variant in product.variants %}
                <tr class="border-b border-gray-700 bg-gray-600 text-sm">
                    <td class="px-6 py-2">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10 hidden sm:table-cell">
                                <img src="https://via.placeholder.com/35" class="w-full h-full rounded-full" alt="Product Thumbnail">
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-2 text-left">{{ variant.title }}</td>
                    <td class="px-6 py-2">
                        <input type="text" value="{{variant.cost}}" max="8" class="w-24 h-8 shadow appearance-none border rounded text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-center invalid:border-red-500" disabled>
                        <button type="button" class="btn-edit" onclick="toggleEdit(this)"><i class="fa fa-edit"></i></button>
                        <button type="submit" class="btn-save hidden" onclick="saveCost(this, {{variant.id}})"><i class="fa fa-save"></i></button>
                    </td>
                </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Product list is empty, try syncing products first</p>
    {% endif %}

{% endblock %}

{% block javascripts %}
    <script>
        function toggleEdit(e) {
            let editButton = e;
            let input = e.parentElement.getElementsByTagName('input')[0];
            let buttons = e.parentElement.getElementsByTagName('button');
            input.disabled = !input.disabled;
            for (button of buttons) {
                button.classList.toggle('hidden');
            }
        }

        function saveCost(e, variantId) {
            let cost = e.parentElement.getElementsByTagName('input')[0].value;
            let data = {cost: cost};

            fetch(`/settings/cogs/${variantId}/update`, {
                method: "POST",
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(res => {
                console.log("Request complete! response:", res);
                if (res.status === 200) {
                    toggleEdit(e);
                } else {
                    alert(res.statusText);
                }
            });
        }
    </script>
{% endblock %}
